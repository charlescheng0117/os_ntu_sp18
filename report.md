report
===

設計
---
我們主要利用 `sched_setscheduler` 來設定 `scheduler` 和各 child Process 之間的互動及控制權。
我們的原始碼包括
- 在資料夾`os_ntu_sp18/src/`中,
    - `Makefile`: 把整個程式make起來。
    - `main.c`: "main.c"裡負責讀測資，將測資存進陣列裡，對過程們的起始時間做排序，並根據測資要求的排程法，將過程們交給相對應的排程器做排程。
    - `scheduler.h`: "scheduler.h" 裡放各個排程器函數的原形。
    - `util.h`: "util.h" 裡是一些公用函數以及會用到的資料結構(`heap`)及排序(`quick_sort`)的方法。在`util.c`中實作。
    - `fifo.c`: "fifo.c"裡是FIFO的實作；利用四個指標rbegin, rend, wbegin和wend來判斷目前可以執行的過程有哪些，並依照先進先出的順序，讓過程們依序執行。
    - `rr.c`: "rr.c"裡是RR的實作，`p_arr` 會記錄所有 child process，而`scheduler` 則會在有 child process 準備好時將它 fork 出來，並放在一個 queue 裡。並在每過 500 個時間單位（一個 time quantum)時，則使用 `deQueue` 將剛執行的 child 拿出來後放在 queue 的尾巴（藉由 `enQueue`）。如此可以讓下一個的 child 執行下 500 個時間單位。每當有 child 結束執行時，則將其從一樣用 `deQueue` 將其移除。當所有 child 執行完後，則結束整個排程。
    - `sjf.c`: "sjf.c"裡是SJF的實作，會去依序檢查按照ready time排序好的`p`裡面之 process。在 parent主要迴圈中根據time counter來檢查是否有 process ready，若有則加入按照execution time比大小的Max heap，並且在沒有任何child執行中時將heap中priority最高(shortest job)的拿出來並fork執行child。 
    - `psjf.c`: "psjf.c"裡是PSJF的實作，在SJF之基礎上進行實作，當有Process之執行時間短於current child剩下的時間，即中斷他並執行新的child，並把剩下的部分加入heap。
- 在資料夾 `os_ntu_sp18/kernel_files/`中,
    - `get_ns_time.c`: 基於 `linux/timekeeping.h` 內定義的function 來實作 `getnstimeofday`
    - `print_ns_time.c`: 基於 `get_ns_time.c` 拿到 `struct timespec` 後，藉由 `prink()` 來將 `tag pid process_start_time process_end_time` print 到 `kernel`，如此便能在 `dmesg` 看到程式執行的結果。



執行範例測資的結果
---
-  FIFO
    - `FIFO_1.txt`
        - in `stdout`
        ```
        P1 2505
        P2 2506
        P3 2507
        P4 2508
        P5 2509
        ```
        - contents of `dmesg`
        ```
        [Project1] 2505 1526298480.049858357 1526298481.181652563
        [Project1] 2506 1526298480.049901333 1526298482.290648655
        [Project1] 2507 1526298480.049933208 1526298483.409995384
        [Project1] 2508 1526298480.049964492 1526298484.538673697
        [Project1] 2509 1526298480.049996878 1526298485.665002904
        ```

    - `FIFO_2.txt`
        - in `stdout`
        ```
        P1 2525
        P2 2526
        P3 2527
        P4 2528
        ```
        - contents of `dmesg`
        ```
        [Project1] 2525 1526298575.155698580 1526298785.085560050
        [Project1] 2526 1526298575.370264432 1526298797.067322475
        [Project1] 2527 1526298575.581445903 1526298799.487049935
        [Project1] 2528 1526298575.791723007 1526298801.969313112
        ```
    - `FIFO_3.txt`
        - in `stdout`
        ```
        P1 2513
        P2 2514
        P3 2515
        P4 2516
        P5 2517
        P6 2518
        P7 2519
        ```
        - contents of `dmesg`
        ```
        [Project1] 2513 1526298493.732672716 1526298511.756737813
        [Project1] 2514 1526298494.160176227 1526298523.037747324
        [Project1] 2515 1526298494.371103117 1526298529.828642350
        [Project1] 2516 1526298494.582303372 1526298532.076894693
        [Project1] 2517 1526298494.796043665 1526298534.322296997
        [Project1] 2518 1526298494.796128049 1526298536.600128923
        [Project1] 2519 1526298495.021916191 1526298545.588101242
        ```

- RR
    - `RR_1.txt`
        - in `stdout`
        ```
        $ sudo ./main < ../OS_PJ1_Test/RR_1.txt
        P1 3968
        P2 3969
        P3 3970
        P4 3971
        P5 3972
        ```

        - Contents in `dmesg`
        
        ```
        $ dmesg
        [Project1] 3968 1526192299.309784848 1526192300.587693946 
        [Project1] 3969 1526192299.309844958 1526192301.852074944
        [Project1] 3970 1526192299.309881872 1526192303.105964508
        [Project1] 3971 1526192299.309921007 1526192304.442967996
        [Project1] 3972 1526192299.309958007 1526192305.734711210
        ```
    - `RR_2.txt`
        - in `stdout`
        ```
        $ sudo ./main < ../OS_PJ1_Test/RR_2.txt
        P1 3988
        P2 3989
        ```
        - Contents in `dmesg`
        ```
        $ dmesg
        [Project1] 3988 1526192570.314929456 1526192589.580193187
        [Project1] 3989 1526192570.777616711 1526192594.026496857
        ```

    - `RR_3.txt`
        - in `stdout`
        ```
        $ sudo ./main < ../OS_PJ1_Test/RR_3.txt
        P3 4004
        P1 4002
        P2 4003
        P6 4007
        P5 4006
        P4 4005
        ```
        - Contents in `dmesg`
        ```
        [Project1] 4004 1526192832.124606878 1526192871.530867628
        [Project1] 4002 1526192824.027234813 1526192877.053973409
        [Project1] 4003 1526192828.035855604 1526192878.335975948
        [Project1] 4007 1526192838.488264920 1526192898.075526022
        [Project1] 4006 1526192836.990602943 1526192900.673542720
        [Project1] 4005 1526192835.999125214 1526192905.931976415
        ```
- SJF
    - `SJF_1.txt`
        - in `stdout`
        ```
        P2 4026
        P3 4027
        P4 4028
        P1 4025
        ```
        - contents in `dmesg`
        ```
        [Project1] 4026 1526392781.752755922 1526392786.248073264
        [Project1] 4027 1526392781.969613491 1526392788.482274012
        [Project1] 4028 1526392782.184170371 1526392797.498765675
        [Project1] 4025 1526392781.752713946 1526392813.370773116
        ```
    - `SJF_2.txt`
        - in `stdout`
        ```
        P2 4055
        P5 4059
        P4 4056
        P3 4058
        P1 4057
        ```
        - contents in `dmesg`
        ```
        [Project1] 4055 1526393086.991609474 1526393087.248581764
        [Project1] 4059 1526393087.248808867 1526393087.730815210
        [Project1] 4056 1526393086.991699709 1526393099.777306068
        [Project1] 4058 1526393087.248772500 1526393112.035408150
        [Project1] 4057 1526393087.248727728 1526393140.816891546
        ```
    - `SJF_3.txt`
        - in `stdout`
        ```
        P1 4068
        P4 4071
        P5 4072
        P6 4073
        P7 4074
        P2 4069
        P3 4070
        P8 4075
        ```
        - contents in `dmesg`
        ```
        [Project1] 4068 1526393192.586571531 1526393199.506559320
        [Project1] 4071 1526393192.815272104 1526393199.530173821
        [Project1] 4072 1526393192.815357398 1526393199.552864318
        [Project1] 4073 1526393193.031656034 1526393208.673062444
        [Project1] 4074 1526393193.252065578 1526393217.784660277
        [Project1] 4069 1526393192.586708919 1526393229.131423891
        [Project1] 4070 1526393192.586790264 1526393245.036792527
        [Project1] 4075 1526393193.516863744 1526393265.602827961
        ```
    - `SJF_4.txt`
        - in `stdout`
        ```
        P2 4084
        P3 4085
        P4 4086
        P1 4083
        ```
        - contents in `dmesg`
        ```
        [Project1] 4084 1526393316.429211343 1526393316.932135079
        [Project1] 4085 1526393316.450935029 1526393317.167173591
        [Project1] 4086 1526393316.475898684 1526393318.187086724
        [Project1] 4083 1526393316.429150551 1526393320.903592321
        ```
    - `SJF_5.txt`
        - in `stdout`
        ```
        P2 4093
        P5 4097
        P4 4094
        P3 4096
        P1 4095
        ```
        - contents in `dmesg`
        ```
        [Project1] 4093 1526393377.648671726 1526393377.670118151
        [Project1] 4097 1526393377.670329861 1526393377.713180674
        [Project1] 4094 1526393377.648758472 1526393378.764222858
        [Project1] 4096 1526393377.670296121 1526393379.697266466
        [Project1] 4095 1526393377.670256705 1526393381.291279316
        ```
    - `SJF_6.txt`
        - in `stdout`
        ```
        P1 4103
        P4 4106
        P5 4107
        P6 4108
        P7 4109
        P2 4104
        P3 4105
        P8 4110
        ```
        - contents in `dmesg`
        ```
        [Project1] 4103 1526393417.515909765 1526393418.172703267
        [Project1] 4106 1526393417.539114784 1526393418.175004774
        [Project1] 4107 1526393417.539212439 1526393418.177249206
        [Project1] 4108 1526393417.561521750 1526393419.082775080
        [Project1] 4109 1526393417.584707429 1526393420.013370237
        [Project1] 4104 1526393417.516010343 1526393421.137937573
        [Project1] 4105 1526393417.516064253 1526393422.823579294
        [Project1] 4110 1526393417.609203815 1526393424.932991527
        ```

- PSJF
    - `PSJF_1.txt`
        - in `stdout`
        ```
        P4 3104
        P3 3103
        P2 3102
        P1 3101
        ```
        - contents in `dmesg`
        ```
        [Project1] 3104 1526389676.450615968 1526389683.416714990
        [Project1] 3103 1526389674.205435503 1526389693.258162894
        [Project1] 3102 1526389671.943064307 1526389708.061725257
        [Project1] 3101 1526389669.570171043 1526389728.913745492
        ```
    - `PSJF_2.txt`
        - in `stdout`
        ```
        P2 3116
        P1 3115
        P4 3118
        P5 3119
        P3 3117
        ```
        - contents in `dmesg`
        ```
        [Project1] 3116 1526389875.661532500 1526389878.498107160
        [Project1] 3115 1526389873.066971515 1526389883.949167066
        [Project1] 3118 1526389886.637611738 1526389891.990890250
        [Project1] 3119 1526389891.991132449 1526389894.982492400
        [Project1] 3117 1526389878.498267757 1526389902.812262039
        ```
    - `PSJF_3.txt`
        - in `stdout`
        ```
        P2 3129
        P3 3130
        P4 3131
        P1 3128
        ```
        - contents in `dmesg`
        ```
        [Project1] 3129 1526389992.915836098 1526389994.180429730
        [Project1] 3130 1526389994.180620531 1526389995.405430752
        [Project1] 3131 1526389995.405581704 1526389996.613410777
        [Project1] 3128 1526389991.720098550 1526390000.201872831
        ```
    - `PSJF_4.txt`
        - in `stdout`
        ```
        P4 3142
        P3 3141
        P2 3140
        P1 3139
        ```
        - contents in `dmesg`
        ```
        [Project1] 3142 1526390106.860014648 1526390106.923299448
        [Project1] 3141 1526390106.837930282 1526390107.008546779
        [Project1] 3140 1526390106.816006318 1526390107.143889074
        [Project1] 3139 1526390106.794179563 1526390107.335126085
        ```
    - `PSJF_5.txt`
        - in `stdout`
        ```
        P2 3187
        P1 3186
        P4 3189
        P5 3190
        P3 3188
        ```
        - contents in `dmesg`
        ```
        [Project1] 3187 1526390334.713581092 1526390334.735222631
        [Project1] 3186 1526390334.687922443 1526390334.778009044
        [Project1] 3189 1526390334.799623017 1526390334.841868288
        [Project1] 3190 1526390334.842002060 1526390334.863006720
        [Project1] 3188 1526390334.735371271 1526390334.926352276
        ```
    - `PSJF_6.txt`
        - in `stdout`
        ```
        P2 3194
        P3 3195
        P4 3196
        P1 3193
        ```
        - contents in `dmesg`
        ```
        [Project1] 3194 1526390338.191809676 1526390338.203151615
        [Project1] 3195 1526390338.203302002 1526390338.214246279
        [Project1] 3196 1526390338.214373262 1526390338.224857576
        [Project1] 3193 1526390338.180840227 1526390338.257682738
        ```

比較實際結果與理論結果，並解釋造成差異的原因
---

我們跑一個一單位時間的Process，開始及結束時間在`dmesg`上分別為：1526390597.924973310, 1526390597.927516093
所以我們假設一單位時間是兩個的差，0.002542783。
- FIFO：
    1. 兩個 Process 結束的時間應該會差500單位，大約是 1.2713915。而且 P1 先結束，再來 P2，...，P5。
       P2-P1:1.108996092
       P3-P2:1.119346729
       P4-P3:1.112867831
       P5-P4:1.126328937
       所以實際上的五百單位時間大約是1.115，比我們自己算的1.27短一點。
       下面例子在估計的時候都用1.115來算
    2. 一樣是P1結束=>P2結束=>P3結束=>P4結束，結束時間差分別是
    5000單位，1000單位，1000單位，所以我們估計是11.15，2.23，2.23。而實際上是
        P2-P1：11.9818
        P3-P2：2.4197
        P4-P3：2.4823
        分別比我們估計的長了一些(約8%)。
    3. 我們用Pi>Pj來表示第i個Process的結束時間比第j個Process的結束時間還要早，那麼P1>P2>P3>P4>P5>P6>P7，結束時間差分別是5000單位，    3000單位，1000單位，1000單位，1000單位，4000單位。估計是11.15，6.69，2.23，2.23，2.23，8.92：
    P2-P1：11.2810
    P3-P2：6.7909
    P4-P3：2.2483
    P5-P4：2.2454
    P6-P5：2.2778
    P7-P6：8.9880
    誤差不到3%，這估計的方法應該可以用

-   RR：
    1. - 理論值：P1>P2>P3>P4
    P(i+1)-P(i)：1.115，1.115，1.115，1.115
       - 實際值：
    P2-P1：1.264
    P3-P2：1.254
    P4-P3：1.337
    P5-P4：1.292
    我們可以跟FIFO的1比較，同樣500單位時間卻都慢了0.1秒多。RR跑的慢了10%左右，基本上差異只在我們寫的scheduler裡面。
    2. - 理論值：P1>P2
    P2-P1 = 3.345
        - 實際值：
    P2-P1：4.4463
    看來RR真的跑得特別慢
    3. - 理論值：P3>P1>P2>P6>P5>P4
    P(i+1)-P(i)：3.3345，1.115，17.690，4.46，2.23
        - 實際值
    P1-P3：5.5231
    P2-P1：1.2820
    P6-P2：19.7340
    P5-P6：2.5980
    P4-P5：5.2584
    - SJF：
    一單位理論時間設為1.115/500=0.00223
    1. - 理論值：P2>P3>P4>P1
    P(i+1)-P(i)：2.23，9.92，15.61
       - 實際值：
    P3-P2：2.2342
    P4-P3：9.016
    P1-P4：15.8720
    較嚴重的是第二個，快了0.9秒。
    2. - 理論值：P2>P5>P4>P3>P1
    P(i+1)-P(i)：0.446，9.92，9.92，15.61
       - 實際值：
    P5-P2：0.4823
    P4-P5：2.0465
    P3-P4：12.2581
    P1-P3：28.7814
    3. - 理論值：P1>P4>P5>P6>P7>P2>P3>P8
    P(i+1)-P(i)：0.223，0.0223，9.92，9.92，11.15，17.690，20.07
       - 實際值：
    P4-P1：0.236
    P5-P4：0.02269
    P6-P5：9.1202
    P7-P6：9.1116
    P2-P7：11.3467
    P3-P2：15.9053
    P8-P3：20.5660
    整體來說，當Process的執行時間短的時候會估計的比較準，執行時間長的時候實際時間會比估計時間短一些，可能是因為我們一開始計算單位時間的方法，是在FIFO裡建一個500單位時間的Process，以結束時間減開始時間來當500單位時間。由於fork()動作太慢了，500不夠大，所以實際上的單位時間比我們想像的短一點，再加上SJF的動作比RR少，所以執行時間一拉長就會比我們預估得快。
    4. - 理論值：P2>P3>P4>P1
    P(i+1)-P(i)：0.223，0.892，1.552
       - 實際值：
    P3-P2：0.2350
    P4-P3：1.0120
    P1-P4：2.7165
   
    5. - 理論值：P2>P5>P4>P3>P1
    P(i+1)-P(i)：0.0446，0.892，0.892，1.552
       - 實際值：
    P5-P2：0.0431
    P4-P5：1.0510
    P3-P4：0.9330
    P1-P3：1.5940
 
    6. - 理論值：P1>P4>P5>P6>P7>P2>P3>P8
    P(i+1)-P(i)：0.00223，0.00223，0.892，0.892，1.115，1.561，2.007
       - 實際值：
    P4-P1：0.0023
    P5-P4：0.002244
    P6-P5：0.9055
    P7-P6：0.9306
    P2-P7：1.1246
    P3-P2：1.6856
    P8-P3：2.1094
      
 - PSJF：
    1.  - 理論值：P4>P3>P2>P1
    P(i+1)-P(i)：9.2，13.8，20.7
        - 實際值
    P3-P4：9.8414
    P2-P3：14.8036
    P1-P2：20.8520
    SJF寫的的確是比較快，PSJF的時間和FIFO的比較接近。
    2. - 理論值：P2>P1>P4>P5>P3
    P(i+1)-P(i)：4.46，6.69，4.46，6.69
       - 實際值：
    P1-P2：5.4511
    P4-P1：8.0417
    P5-P4：2.9916
    可能是PSJF每次強奪的過程都用了一個fork()導致variance很大。
    3. - 理論值：P2>P3>P4>P1
     P(i+1)-P(i)：1.115，1.115，3.345
       - 實際值：
     P3-P2：1.2250
     P4-P3：1.2080
     P1-P4：3.5885
     
    4. - 理論值：P4>P3>P2>P1
     P(i+1)-P(i)：0.0892，0.1115，0.1338，0.2007
       - 實際值：
     P3-P4：0.08524
     P2-P3：0.1353
     P1-P2：0.1912
     
    5. - 理論值：P2>P1>P4>P5>P3
    P(i+1)-P(i)：0.0446，0.0669，0.0223，0.0669
       - 實際值：
    P1-P2：0.04278
    P4-P1：0.06386
    P5-P4：0.02114
    P3-P5：0.06334
    
    6. - 理論值：P2>P3>P4>P1
    P(i+1)-P(i)：0.01115，0.01115，0.03345
       - 實際值：
    P3-P2：0.01109
    P4-P3：0.01061
    P1-P4：0.03282
    第三到第六次預估的時間都滿準的，估計是因為我們一開始算一個單位時間的時候是用FIFO一個500單位時間的Process，所以如果每個Process的執行時間都再500以內的話就可以估的滿準的。
    
- 小總結：
    - 以穩定度來講，
    FIFO>RR>PSJF>SJF
    - 速度則是
    SJF>FIFO=PSJF>RR
    - 跑一個一單位時間的Process需要的時間不只一單位，一次跑個100單位做平均會比較妥當。
    - 由於測試的時間單位太少，猜測程式內的 system call 太慢所導致，不過順序都是對的。

各組員的貢獻
---

R05246009 應數所碩二 吳其豪
1. 負責整體原始碼(Makefile, *.c, *.h) 的架構
2. 簡化 scheduler 排程的實作
3. 負責 FIFO, SJF, PSJF 實作

R06723041 財金所碩一 鄭晏奇
1. 利用 `sched_setscheduler` 來使控制權自 scheduler 和 child Process 間互相轉換
2. 負責 kernel_files 的實作並重新編譯 kernel。使 Program OutPut 能利用 `getnstimeofday` 去查看奈秒的資訊，以及 `Prink` ：使 `dmesg` 包含每個 Process 開始和結束的時間
3. 負責 RR 實作

B03201003 數學系大四 林永濬
1. 利用 signal 使 Parent, child 間互相溝通
2. 負責 SJF, PSJF 實作
3. 負責 Priority queue, quick sort 實作

B03201013 數學系大四 郭子翔
1. 負責構思虛擬碼
2. 計算並分析實際結果與理論結果之差異